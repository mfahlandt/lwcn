name: Send Newsletter Email

on:
  # Trigger when newsletter files are pushed to main
  push:
    branches:
      - main
    paths:
      - 'website/content/newsletter/2*-week-*.md'
      - '!website/content/newsletter/*-articles.md'
      - '!website/content/newsletter/*-linkedin.txt'
  # Manual trigger
  workflow_dispatch:
    inputs:
      newsletter_file:
        description: 'Newsletter file to send (e.g., 2026-week-04.md)'
        required: false
        type: string

jobs:
  send-email:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect new files

      - name: Find newsletter to send
        id: find-newsletter
        run: |
          if [ -n "${{ github.event.inputs.newsletter_file }}" ]; then
            # Manual trigger with specific file
            NEWSLETTER_FILE="website/content/newsletter/${{ github.event.inputs.newsletter_file }}"
          else
            # Auto-detect: find the newest newsletter file that was added/modified
            NEWSLETTER_FILE=$(git diff --name-only HEAD~1 HEAD -- 'website/content/newsletter/*.md' | \
              grep -E '[0-9]{4}-week-[0-9]{2}\.md$' | \
              head -1)
          fi
          
          if [ -z "$NEWSLETTER_FILE" ] || [ ! -f "$NEWSLETTER_FILE" ]; then
            echo "No newsletter file found to send"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "newsletter_file=$NEWSLETTER_FILE" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "Found newsletter: $NEWSLETTER_FILE"

      - name: Extract newsletter content
        if: steps.find-newsletter.outputs.skip != 'true'
        id: extract
        run: |
          FILE="${{ steps.find-newsletter.outputs.newsletter_file }}"
          
          # Extract title from frontmatter
          TITLE=$(grep -m1 '^title:' "$FILE" | sed 's/title: *//' | tr -d '"')
          
          # Extract content (everything after the second ---)
          CONTENT=$(awk '/^---$/{p++} p==2{if(NR>1)print}' "$FILE" | tail -n +2)
          
          # Save to files for the API call
          echo "$TITLE" > /tmp/newsletter_title.txt
          echo "$CONTENT" > /tmp/newsletter_content.md
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "Newsletter title: $TITLE"

      - name: Send via Buttondown API
        if: steps.find-newsletter.outputs.skip != 'true'
        env:
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
        run: |
          TITLE=$(cat /tmp/newsletter_title.txt)
          CONTENT=$(cat /tmp/newsletter_content.md)
          
          # Create JSON payload
          jq -n \
            --arg subject "LWCN: $TITLE" \
            --arg body "$CONTENT" \
            '{subject: $subject, body: $body, status: "draft"}' > /tmp/payload.json
          
          # Send to Buttondown API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.buttondown.com/v1/emails" \
            -H "Authorization: Token $BUTTONDOWN_API_KEY" \
            -H "Content-Type: application/json" \
            -d @/tmp/payload.json)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Newsletter draft created in Buttondown!"
            echo "Go to https://buttondown.com/emails to review and send it."
          else
            echo "❌ Failed to create newsletter draft"
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi
